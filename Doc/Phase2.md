# Phase2 機能要件

## 1. 画面レイアウト
- ページ全体を、上部の「データ入力エリア」と下部の「データリストエリア」に上下分割する。
- 「データリストエリア」は、さらに上部の「検索条件エリア」と下部の「データエリア」に上下分割する。
- 今回のリファクタリングに際し、元のデザインは一切変更せず、データリストエリアの追加のみとする
- なお、データリストエリアのデザインも、同ページデザインに合わせるものとする

## 2. データリスト
### 表示仕様
- **対象データ:** `line_uid_entries` テーブル
- **表示項目:** 
  - `line_uid`
  - `points`
  - `month`
  - `day`
  - `hour`
  - `minute`
  - `ng_reason` (理由テキスト)
  - `is_duplicate`: 「**重複**」という文字列で表示
  - `created_at`: 「**YYYY/MM/DD HH:mm**」形式で表示
  - `worker_code`
- **デフォルトの並び順:** `created_at` の降順 (新しいものが上)
- **ソート機能:** 
  - データエリアの各列のヘッダーをクリック可能にする。
  - 1回目のクリックで、その列を基準に「昇順」で並び替える。
  - 既にその列で昇順になっている場合、2回目のクリックで「降順」に並び替える。
- **UI:**
  - データエリアはページングせず、エリア内をスクロールして全件表示する。
  - 各データ行に編集ボタン（ペンアイコン）を配置する。

### 検索機能
- **検索条件エリアに以下の項目を配置する:**
  - **LINE UID (`line_uid`):**
    - テキスト入力フィールドを設置し、入力されたUIDと一致するデータを検索できるようにする。
  - **作業者 (`worker_code`):**
    - `select`要素を使用する。
    - ログインユーザーが管理者 (`is_admin=1`) の場合、全作業者を選択可能とする。
    - 一般ユーザーの場合、自身の `worker_code` で固定し、変更不可とする。
  - **登録日時 (`created_at`):**
    - 日付範囲ピッカーを使用し、「YYYY-MM-DD」形式で開始日と終了日を指定できるようにする。

### データ更新
- データ登録・更新・削除後は、データリストを再取得して最新の状態に更新する。

## 3. 編集機能
### フォームの状態管理
- フロントエンドのフォームは「**新規作成モード**」と「**編集モード**」の2つの状態を持つものとする。
- 通常は「新規作成モード」とし、データリストの編集ボタンが押された際に「編集モード」に切り替わる。

### 編集フロー
1.  データリストの行にある編集ボタンをクリックすると、「編集モード」に移行する。
2.  クリックされた行のデータが、ページ上部の「データ入力エリア」の各フォーム項目にセットされる。
    - **入力チェック:** フォームに未保存のデータ（初期値以外）が入力されている場合、「現在入力中のデータは破棄されますがよろしいですか？」という確認モーダルを表示する。`はい`を選択した場合のみ処理を続行する。
3.  「編集モード」では、フォームの「登録」ボタンが「**更新**」ボタンに変わる。
4.  「更新」ボタンクリック時、「データを更新しますか？」という確認モーダルを表示する。`はい`を選択した場合のみ更新APIを呼び出す。
5.  データ更新後、リストは再取得される（この際、特別なスクロール位置調整は不要）。
6.  フォームエリアに「**編集キャンセル**」ボタンを配置する。このボタンは「編集モード」の時のみ有効化され、クリックするとフォームをクリアして「新規作成モード」に戻る。

## 4. 実装方針サマリ
- **確認モーダル:**
  - `DuplicateConfirmationModal.tsx` を参考に、メッセージや処理をpropsで指定できる汎用的な確認モーダルコンポーネントを新規作成する。
- **ユーザー権限:**
  - ログインユーザーの管理者権限（is_admin）は、`usePage().props.auth.user` オブジェクトから取得することを前提とする。

## 5. API仕様
Phase2の実装にあたり、以下のAPIエンドポイントを定義または利用する。

### 1. 登録済みデータリスト取得 (新規作成)
登録済みのデータリストを、検索条件やソート条件に応じて取得するためのAPI。

-   **エンドポイント:** `GET /api/entries`
-   **認証:** 必要 (Sanctum)
-   **コントローラ:** `LineUidEntryController@index`
-   **クエリパラメータ:**
    -   `line_uid` (string, optional): LINE UIDで絞り込む（完全一致）。
    -   `worker_code` (string, optional): 作業者コードで絞り込む。
    -   `start_date` (string, optional): 登録日時の範囲開始日 (`YYYY-MM-DD`形式)。
    -   `end_date` (string, optional): 登録日時の範囲終了日 (`YYYY-MM-DD`形式)。
    -   `sort_by` (string, optional): ソート対象のカラム名 (例: `points`)。デフォルトは `created_at`。
    -   `sort_order` (string, optional): ソート順 (`asc` or `desc`)。デフォルトは `desc`。
-   **成功レスポンス (200 OK):**
    ```json
    [
        {
            "id": 1,
            "line_uid": "U123456789...",
            "points": 100,
            "month": 9,
            "day": 11,
            "hour": 10,
            "minute": 30,
            "is_duplicate": false,
            "created_at": "2025-09-11T10:30:00.000000Z",
            "ng_reason": {
                "id": 1,
                "reason": "指定なし"
            },
            "worker": {
                "worker_code": "J01",
                "name": "作業者A"
            }
        }
    ]
    ```

### 2. データ更新 (新規作成)
指定したIDのデータを入力フォームの内容で更新するためのAPI。

-   **エンドポイント:** `PUT /api/entries/{entry}`
-   **認証:** 必要 (Sanctum)
-   **コントローラ:** `LineUidEntryController@update`
-   **URLパラメータ:**
    -   `{entry}`: 更新対象の `line_uid_entries` のID。
-   **リクエストボディ:**
    ```json
    {
        "line_uid": "U123456789...",
        "points": 150,
        "month": 9,
        "day": 11,
        "hour": 10,
        "minute": 35,
        "ng_reason_id": 2
    }
    ```
-   **成功レスポンス (200 OK):** 更新後のリソースデータを返す。
    ```json
    {
        "id": 1,
        "line_uid": "U123456789...",
        "points": 150,
        // ... other fields
    }
    ```

### 3. 作業者リスト取得 (既存API利用)
検索フィルターのドロップダウンに表示する作業者の一覧を取得するためのAPI。管理者権限を持つユーザーのみが利用する。

-   **エンドポイント:** `GET /api/admin/workers`
-   **認証:** 必要 (Sanctum, adminミドルウェア)
-   **コントローラ:** `AdminWorkerController@index`
-   **成功レスポンス (200 OK):**
    ```json
    [
        {
            "id": 1,
            "worker_code": "J01",
            "name": "作業者A"
        },
        {
            "id": 2,
            "worker_code": "J02",
            "name": "作業者B"
        }
    ]
    ```
